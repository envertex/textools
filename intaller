#!/usr/bin/env bash
# Author: envertex

set -Eeuo pipefail

# =======================
# CONFIG
# =======================
REPO_NAME="textools"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MODULES_DIR="$SCRIPT_DIR/modules"

# ---- EXECUTION ORDER (STRICT) ----
MODULE_ORDER=(
  "sudo"
  "blackarch"
  "tools"
  "word-list"
  "envertextools"
)

# =======================
# COLORS (optional visual)
# =======================
CLR_INFO="\033[0;34m"
CLR_OK="\033[0;32m"
CLR_WARN="\033[1;33m"
CLR_ERROR="\033[0;31m"
CLR_DEBUG="\033[0;35m"
CLR_RESET="\033[0m"

# =======================
# FLAGS
# =======================
MODE_ALL=false
ASSUME_YES=false
LIST_ONLY=false
DRY_RUN=false
UPDATE_REPO=false
SINGLE_MODULES=()
SKIP_PATTERNS=()

# =======================
# LOGGING
# =======================
log_info()  { echo -e "${CLR_INFO}[INFO]${CLR_RESET}  $1"; }
log_ok()    { echo -e "${CLR_OK}[OK]${CLR_RESET}    $1"; }
log_warn()  { echo -e "${CLR_WARN}[WARN]${CLR_RESET}  $1"; }
log_error() { echo -e "${CLR_ERROR}[ERROR]${CLR_RESET} $1"; }
log_debug() { echo -e "${CLR_DEBUG}[DEBUG]${CLR_RESET} $1"; }

# =======================
# ERROR HANDLER
# =======================
on_error() {
  log_error "Installer aborted at line $1"
  exit 1
}
trap 'on_error $LINENO' ERR

# =======================
# ROOT VALIDATION
# =======================
if [[ "$EUID" -ne 0 ]]; then
  log_error "This installer must be run as root"
  log_info  "Usage: sudo ./install.sh"
  exit 1
fi

log_debug "Running as root (EUID=$EUID)"

# =======================
# HELP
# =======================
show_help() {
cat <<EOF
textools installer

Usage:
  sudo ./install.sh [options]

Options:
  -h, --help        Show help
  -A, --all         Run all modules without prompting
  -y, --yes         Auto-confirm execution
  -l, --list        Show module execution order
  -s, --single FILE Run only specific module (repeatable or CSV)
  -d, --dry-run     Show execution plan only
  -u, --update      Update repository (git pull)
  --skip PATTERN    Skip modules matching pattern
EOF
exit 0
}

# =======================
# UTILS
# =======================
append_csv() {
  local csv="$1" target="$2"
  IFS=',' read -ra parts <<< "$csv"
  for p in "${parts[@]}"; do
    p="${p// /}"
    [[ -n "$p" ]] && eval "$target+=(\"$p\")"
  done
}

contains() {
  local x
  for x in "${@:2}"; do [[ "$x" == "$1" ]] && return 0; done
  return 1
}

# =======================
# ARG PARSING
# =======================
log_debug "Parsing arguments"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) show_help ;;
    -A|--all) MODE_ALL=true ;;
    -y|--yes) ASSUME_YES=true ;;
    -l|--list) LIST_ONLY=true ;;
    -d|--dry-run) DRY_RUN=true ;;
    -u|--update) UPDATE_REPO=true ;;
    -s|--single)
      shift || { log_error "--single requires argument"; exit 1; }
      append_csv "$1" SINGLE_MODULES
      ;;
    --skip)
      shift || { log_error "--skip requires argument"; exit 1; }
      append_csv "$1" SKIP_PATTERNS
      ;;
    *)
      log_error "Unknown option: $1"
      show_help
      ;;
  esac
  shift
done

# =======================
# MODULE VALIDATION
# =======================
log_debug "Validating module directory"

[[ -d "$MODULES_DIR" ]] || {
  log_error "modules/ directory not found"
  exit 1
}

log_debug "Validating module list"

for m in "${MODULE_ORDER[@]}"; do
  [[ -f "$MODULES_DIR/$m" ]] || {
    log_error "Missing module: modules/$m"
    exit 1
  done
done

# =======================
# LIST
# =======================
if $LIST_ONLY; then
  for m in "${MODULE_ORDER[@]}"; do
    echo "$m"
  done
  exit 0
fi

# =======================
# DRY RUN
# =======================
if $DRY_RUN; then
  log_info "Dry-run mode enabled"
  for m in "${MODULE_ORDER[@]}"; do
    [[ ${#SINGLE_MODULES[@]} -gt 0 ]] && ! contains "$m" "${SINGLE_MODULES[@]}" && continue
    for s in "${SKIP_PATTERNS[@]}"; do [[ "$m" == *"$s"* ]] && continue 2; done
    echo "$m"
  done
  exit 0
fi

# =======================
# UPDATE
# =======================
if $UPDATE_REPO; then
  log_info "Updating repository: $REPO_NAME"
  git -C "$SCRIPT_DIR" pull || log_warn "git pull failed"
fi

# =======================
# MAIN
# =======================
log_info "Starting $REPO_NAME installer"
log_debug "Modules path: $MODULES_DIR"

for module in "${MODULE_ORDER[@]}"; do
  [[ ${#SINGLE_MODULES[@]} -gt 0 ]] && ! contains "$module" "${SINGLE_MODULES[@]}" && continue
  for s in "${SKIP_PATTERNS[@]}"; do [[ "$module" == *"$s"* ]] && continue 2; done

  log_info "Module start: $module"

  if ! $MODE_ALL && ! $ASSUME_YES; then
    read -rp "Execute module '$module'? [Y/n] " ans
    [[ "${ans:-Y}" =~ ^[Nn]$ ]] && log_warn "Module skipped: $module" && continue
  fi

  if bash "$MODULES_DIR/$module"; then
    log_ok "Module finished: $module"
  else
    log_error "Module failed: $module"
    exit 1
  fi
done

log_ok "Installation completed successfully"
exit 0
