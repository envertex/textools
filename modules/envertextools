#!/usr/bin/env bash
# Module: misc-tools
# Purpose: Install envertex misc tools (g3ktools)
# Author: envertex

set -Eeuo pipefail

# =======================
# LOGGING
# =======================
CLR_INFO="\033[0;34m"
CLR_OK="\033[0;32m"
CLR_WARN="\033[1;33m"
CLR_ERROR="\033[0;31m"
CLR_RESET="\033[0m"

log_info()  { echo -e "${CLR_INFO}[INFO]${CLR_RESET}  $1"; }
log_ok()    { echo -e "${CLR_OK}[OK]${CLR_RESET}    $1"; }
log_warn()  { echo -e "${CLR_WARN}[WARN]${CLR_RESET}  $1"; }
log_error() { echo -e "${CLR_ERROR}[ERROR]${CLR_RESET} $1"; }

# =======================
# ROOT + OS CHECK
# =======================
if [[ "$EUID" -ne 0 ]]; then
  log_error "Must be run as root"
  exit 1
fi

if ! command -v git &>/dev/null; then
  log_error "git not found"
  exit 1
fi

# =======================
# VARIABLES
# =======================
REPO_URL="https://github.com/envertex/tools"
DEST_DIR="/tools"
REAL_USER="${SUDO_USER:-root}"

# =======================
# REMOVE EXISTING
# =======================
if [[ -d "$DEST_DIR" ]]; then
  log_info "Removing existing $DEST_DIR"
  rm -rf "$DEST_DIR"
  log_ok "$DEST_DIR removed"
fi

# =======================
# CLONE REPOSITORY
# =======================
log_info "Cloning envertex tools repository"
if git clone --depth 1 "$REPO_URL" "$DEST_DIR" &>/dev/null; then
  log_ok "Repository cloned to $DEST_DIR"
else
  log_error "Failed to clone repository"
  exit 1
fi

# =======================
# PERMISSIONS
# =======================
log_info "Fixing permissions"
chown -R "$REAL_USER:$REAL_USER" "$DEST_DIR" || true
chmod -R 755 "$DEST_DIR" || true
log_ok "Permissions applied"

# =======================
# INSTALL BINARIES
# =======================
if [[ -d "$DEST_DIR/bin" ]]; then
  log_info "Installing binaries into /usr/bin"
  cp -a "$DEST_DIR/bin/"* /usr/bin/ 2>/dev/null || true
  rm -rf "$DEST_DIR/bin"
  log_ok "Binaries installed"
else
  log_warn "No bin directory found, skipping binary install"
fi

# =======================
# LINUX TOOLS SETUP
# =======================
if [[ -x "$DEST_DIR/linux/install_linux_tools.sh" ]]; then
  log_info "Running Linux tools installer"
  bash "$DEST_DIR/linux/install_linux_tools.sh"
  log_ok "Linux tools installed"
else
  log_warn "Linux installer not found"
fi

# =======================
# WINDOWS TOOLS SETUP
# =======================
if [[ -x "$DEST_DIR/windows/install_windows_tools.sh" ]]; then
  log_info "Running Windows tools installer"
  bash "$DEST_DIR/windows/install_windows_tools.sh"
  log_ok "Windows tools installed"
else
  log_warn "Windows installer not found"
fi

# =======================
# CLEANUP INSTALL SCRIPTS
# =======================
rm -f "$DEST_DIR/linux/install_linux_tools.sh" 2>/dev/null || true
rm -f "$DEST_DIR/windows/install_windows_tools.sh" 2>/dev/null || true

# =======================
# DONE
# =======================
log_ok "envertex misc tools installed successfully"
exit 0
