#!/usr/bin/env bash
# Module: sudo
# Purpose: Configure NOPASSWD sudo access
# Author: envertex

set -Eeuo pipefail

# =======================
# LOGGING (same style as installer)
# =======================
CLR_INFO="\033[0;34m"
CLR_OK="\033[0;32m"
CLR_WARN="\033[1;33m"
CLR_ERROR="\033[0;31m"
CLR_DEBUG="\033[0;35m"
CLR_RESET="\033[0m"

log_info()  { echo -e "${CLR_INFO}[INFO]${CLR_RESET}  $1"; }
log_ok()    { echo -e "${CLR_OK}[OK]${CLR_RESET}    $1"; }
log_warn()  { echo -e "${CLR_WARN}[WARN]${CLR_RESET}  $1"; }
log_error() { echo -e "${CLR_ERROR}[ERROR]${CLR_RESET} $1"; }
log_debug() { echo -e "${CLR_DEBUG}[DEBUG]${CLR_RESET} $1"; }

# =======================
# ERROR HANDLER
# =======================
on_error() {
  log_error "Module failed at line $1"
  exit 1
}
trap 'on_error $LINENO' ERR

# =======================
# ROOT VALIDATION
# =======================
if [[ "$EUID" -ne 0 ]]; then
  log_error "This module must be executed as root"
  exit 1
fi

log_debug "Running as root (EUID=$EUID)"

# =======================
# TARGET USER RESOLUTION
# =======================
if [[ -n "${SUDO_USER:-}" && "${SUDO_USER}" != "root" ]]; then
  USER_NAME="$SUDO_USER"
else
  USER_NAME="$(logname 2>/dev/null || true)"
fi

if [[ -z "${USER_NAME:-}" ]]; then
  log_error "Unable to determine target user"
  exit 1
fi

log_info "Target user: $USER_NAME"

# =======================
# USER VALIDATION
# =======================
if ! id "$USER_NAME" &>/dev/null; then
  log_error "User does not exist: $USER_NAME"
  exit 1
fi

if [[ "$USER_NAME" == "root" ]]; then
  log_warn "Target user is root — skipping sudoers modification"
  exit 0
fi

# =======================
# SUDOERS FILE
# =======================
SUDO_FILE="/etc/sudoers.d/99_${USER_NAME}"

log_debug "Sudoers file path: $SUDO_FILE"

if [[ -f "$SUDO_FILE" ]]; then
  log_warn "Sudoers file already exists: $SUDO_FILE"
else
  log_info "Creating sudoers file"
  install -m 440 -o root -g root /dev/null "$SUDO_FILE"
fi

# =======================
# WRITE CONFIG
# =======================
log_info "Writing NOPASSWD configuration"

cat > "$SUDO_FILE" <<EOF
# Managed by textools
# User: $USER_NAME
$USER_NAME ALL=(ALL) NOPASSWD: ALL
EOF

# =======================
# VALIDATE WITH VISUDO
# =======================
log_info "Validating sudoers syntax"

if ! visudo -cf "$SUDO_FILE"; then
  log_error "Invalid sudoers syntax — rolling back"
  rm -f "$SUDO_FILE"
  exit 1
fi

# =======================
# FINAL CHECK
# =======================
log_ok "NOPASSWD sudo configured successfully "
log_info "Verification: run 'sudo -l' as $USER_NAME"

exit 0
